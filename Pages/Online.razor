@page "/Online/{GameId?}"
@inject NavigationManager Navigation

<CascadingValue Value="@PlayerColor">
    <CascadingValue Value="@GameState">
        <CascadingValue Value="@GameId">
            <CascadingValue Value="@hubConnection">
                <Chat Messages="@messages"></Chat>
                <div>
                    @if (UserState.username is not null)
                    {
                        <p>@UserState.username</p>
                    }
                    @if (hubConnection is not null)
                    {
                        <p>@hubConnection.ConnectionId</p>
                    }
                    @if (GameId is not null)
                    {
                        <p>@GameId</p>
                    }
                    @if (errorMessage is not null)
                    {
                        <p style="color: red">@errorMessage</p>
                    }
                    @if (GameState.KingInCheck)
                    {
                        <p style="color: yellow">Check!</p>
                    }
                    @if (GameState.CheckMate)
                    {
                        <p style="color:green">Checkmate!</p>
                        <p style="color:green">@GameState.VictoryColor wins!</p>
                    }
                    <p>@GameState.CurrentTurnColor</p>
                    <p>@PlayerColor</p>
                </div>
                <Chess></Chess>
            </CascadingValue>
        </CascadingValue>
    </CascadingValue>
</CascadingValue>

@if (UserState.username is null)
{
    <div class="Login">
        <div class="LoginCard">
            <h2 class="loginh2">Enter Your Name</h2>
            <input class="loginInput" @bind="usernameInput" @bind:event="oninput" @onkeydown="@Enter" />
            <button class="btn loginButton" @onclick="@SetUsername">Submit</button>
        </div>
    </div>
}


@code {
    [CascadingParameter]
    private UserStateProvider UserState { get; set; }
    [Parameter]
    public string? GameId { get; set; }
    private HubConnection? hubConnection;
    private List<Tuple<string, string>> messages = new List<Tuple<string, string>>();
    private string? usernameInput;
    private string? errorMessage;
    public ColorEnum? PlayerColor;
    public Game? GameState = new Game();
    protected override async Task OnInitializedAsync()
    {
        hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/ChessHub"))
            .Build();

        hubConnection.On<string, string>("ReceiveMessage", (username, message) =>
        {
            messages.Add(Tuple.Create(username, message));
            InvokeAsync(StateHasChanged);
        });
        hubConnection.On<string>("ReceiveErrorMessage", (message) =>
        {
            errorMessage = message;
            InvokeAsync(StateHasChanged);
        });
        hubConnection.On<string>("ReceiveInitializeGame", (serverGameJson) =>
        {
            errorMessage = "Game started!";
            ServerGame serverGame = JsonHandler.ServerGameFromJson(serverGameJson);
            GameState = serverGame.game;
            PlayerColor = UserState.userId == serverGame.PlayerOneId ? serverGame.PlayerOneColor : serverGame.PlayerTwoColor;
            InvokeAsync(StateHasChanged);
        });
        hubConnection.On<string>("ReceiveUpdateGame", (gameJson) =>
        {
            GameState = JsonHandler.GameFromJson(gameJson);
            InvokeAsync(StateHasChanged);
        });
        hubConnection.On<string>("ReceiveAddSpectator", (serverGameJson) =>
        {
            errorMessage = "You are spectating";
            ServerGame serverGame = JsonHandler.ServerGameFromJson(serverGameJson);
            GameState = serverGame.game;
            PlayerColor = null;
            InvokeAsync(StateHasChanged);
        });
        hubConnection.On<string>("ReceiveRejoinGame", (serverGameJson) =>
        {
            errorMessage = "Game rejoined";
            ServerGame serverGame = JsonHandler.ServerGameFromJson(serverGameJson);
            GameState = serverGame.game;
            PlayerColor = UserState.userId == serverGame.PlayerOneId ? serverGame.PlayerOneColor : serverGame.PlayerTwoColor;
            InvokeAsync(StateHasChanged);
        });

        await hubConnection.StartAsync();

        if (GameId is not null)
        {
            await hubConnection.SendAsync("AddToGroup", GameId, UserState.userId);
        }

    }

    private async Task Enter(KeyboardEventArgs e)
    {
        if (e.Code == "Enter" || e.Code == "NumpadEnter")
        {
            await SetUsername();
        }
    }

    private async Task SetUsername()
    {
        if (usernameInput != null)
        {
            UserState.username = usernameInput;
            await UserState.SaveChangesAsync();
        }
    }
}